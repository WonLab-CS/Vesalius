<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Vesalius: MSB Manuscript Analysis • vesalius</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Vesalius: MSB Manuscript Analysis">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">vesalius</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../articles/vesalius.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../../articles/Vesalius_Analysis/Spatial_DNA_seq.html">Vesalius: Spatial Genomics</a></li>
    <li><a class="dropdown-item" href="../../articles/Vesalius_Analysis/Spatial_RNA_seq.html">Vesalius: Spatial Transcriptomics</a></li>
    <li><a class="dropdown-item" href="../../articles/Vesalius_Analysis/Vesalius_MSB_analysis.html">Vesalius: MSB Manuscript Analysis</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/patrickCNMartin/Vesalius/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Vesalius: MSB Manuscript Analysis</h1>
                        <h4 data-toc-skip class="author">Patrick C.N.
Martin</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/patrickCNMartin/Vesalius/blob/main/vignettes/Vesalius_Analysis/Vesalius_MSB_analysis.Rmd" class="external-link"><code>vignettes/Vesalius_Analysis/Vesalius_MSB_analysis.Rmd</code></a></small>
      <div class="d-none name"><code>Vesalius_MSB_analysis.Rmd</code></div>
    </div>

    
    
<p><em>IMPORTANT NOTICE</em></p>
<p>The code provide here shows the work flow using vesalius 1.0.1.</p>
<p>The forzen source code can be found (here)[<a href="https://github.com/patrickCNMartin/Vesalius/releases/tag/Release_1.0.1" class="external-link uri">https://github.com/patrickCNMartin/Vesalius/releases/tag/Release_1.0.1</a>]</p>
<div class="section level2">
<h2 id="preface">Preface<a class="anchor" aria-label="anchor" href="#preface"></a>
</h2>
<p>The following file contains all code related to Spatial
Transcriptomics analysis using Vesalius. While this file contains the
code used to produce all analysis figures in the manuscript, the order
of the code is somewhat different to that of the paper.</p>
<p>We hope that this can also serve as a <em>vignette</em> describing
various analysis possibilities provided by Vesalius. Each section or
sub-section will indicate in which figure their respective output can be
found.</p>
<p>Please note that the code related to Vesalius benchmarking and
comparison to other methods can be found <a href="https://github.com/patrickCNMartin/Vesalius/tree/main/methodComp" class="external-link">here</a>.</p>
<p><strong>NOTE change path to files accordingly</strong></p>
</div>
<div class="section level2">
<h2 id="set-up">Set up<a class="anchor" aria-label="anchor" href="#set-up"></a>
</h2>
<p>First, we will set up the R environment to run Vesalius. Note that
some of the packages are Vesalius dependencies but for sake of clarity,
they are also listed here. We also set a seed. Some functions (such as
<code>kmeans</code>) requires random start points. This seed ensure that
you will (hopefully) recover the same territories as we had in the
paper.</p>
<div class="section level3">
<h3 id="libraries">Libraries<a class="anchor" aria-label="anchor" href="#libraries"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patrickcnmartin.github.io/Vesalius/" class="external-link">vesalius</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://asgr.github.io/imager/" class="external-link">imager</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ShotaOchi/imagerExtra" class="external-link">imagerExtra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kisungyou/tvR" class="external-link">tvR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/" class="external-link">sp</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Standard libraries - just in case you are a command line fiend</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">utils</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">graphics</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">grDevices</span><span class="op">)</span></span>
<span><span class="co">### Set seed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="vesalius-images">Vesalius Images<a class="anchor" aria-label="anchor" href="#vesalius-images"></a>
</h2>
<div class="section level3">
<h3 id="rgb-embeddings">RGB embeddings<a class="anchor" aria-label="anchor" href="#rgb-embeddings"></a>
</h3>
<p>The first step of the Vesalius algorithm is to load and pre-process
spatial transcriptomic data. For this manuscript, we used slide-seqV2
data provided on the <a href="https://singlecell.broadinstitute.org/single_cell/study/SCP948/robust-decomposition-of-cell-type-mixtures-in-spatial-transcriptomics#study-download" class="external-link">Single
Cell Portal</a>. Our analysis mainly focused on the mouse brain and
embryo (E12.5). We also used SeqScope data available <a href="https://deepblue.lib.umich.edu/data/concern/data_sets/9c67wn05f" class="external-link">here</a>.
Please note that the SeqScope dataset have already be preprocess and do
not require further processing.</p>
<p>Once the data has been loaded and pre-processed (log normalisation,
scaling, Finding variable features - handled by Seurat), the data can be
parsed to Vesalius for embedding into the RGB colour space.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Only 2 pucks were used - but ultimately you can add as many as you want</span></span>
<span><span class="co"># The first one is the mouse Hippocampus, the second is mouse embryo</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">slideTag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Puck_200115_08"</span>,<span class="st">"Puck_190926_03"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slideBeads</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08_bead_locations.csv"</span>,</span>
<span>               <span class="st">"~/group/slide_seqV2/Puck_190926_03_bead_locations.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slideCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08.digital_expression.txt.gz"</span>,</span>
<span>                 <span class="st">"~/group/slide_seqV2/Puck_190926_03.digital_expression.txt.gz"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Next we can set a few parameters for the pre-processing</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co">## number of variable features</span></span>
<span><span class="va">nfeatures</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span></span>
<span><span class="co">## Plot output directory</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="st">"~/group/slide_seqV2/plots/"</span></span>
<span></span>
<span></span>
<span><span class="co">## Output directory</span></span>
<span><span class="va">IP</span> <span class="op">&lt;-</span> <span class="st">"~/group/slide_seqV2/IP/"</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Looping over files and converting UMAP projection values to RGB colours</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">countList</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">slideTag</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Loading Bead file"</span>,<span class="va">slideTag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Loading coordinates</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">bead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ReadSlideSeq.html" class="external-link">ReadSlideSeq</a></span><span class="op">(</span><span class="va">slideBeads</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Loading Count file"</span>,<span class="va">slideTag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Unconventional loading - however required as some data sets</span></span>
<span>  <span class="co"># Fail to load  - This ensures all data sets can be loaded</span></span>
<span>  <span class="co"># Count matrix</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">slideCounts</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, header <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">count</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="va">count</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Creating seurat spatial object</span></span>
<span>  <span class="co"># NOTE this code is taken from the Seurat source code as it does not seem that</span></span>
<span>  <span class="co"># Slide seq loading function are all exported</span></span>
<span>  <span class="co"># If this has been updated - this section can be changed accordingly</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span><span class="va">count</span>, assay <span class="op">=</span><span class="st">"Spatial"</span><span class="op">)</span></span>
<span>  <span class="va">bead</span> <span class="op">&lt;-</span> <span class="va">bead</span><span class="op">[</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/Cells.html" class="external-link">Cells</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">count</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">bead</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span></span>
<span>  <span class="va">count</span><span class="op">[[</span><span class="st">"slice1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bead</span></span>
<span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Seuart pre-processing steps</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">count</span>, nfeatures <span class="op">=</span> <span class="va">nfeatures</span><span class="op">)</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Embed PCA loading into the RGB colour space.</span></span>
<span>  <span class="co"># NOTE that the output of this function only assigns colours to each</span></span>
<span>  <span class="co"># coordinates we do not have an image yet.</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu">rgbUMAP</span><span class="op">(</span><span class="va">count</span>, pcs <span class="op">=</span><span class="fl">30</span>, conserveSparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">countList</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">count</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># exporting embeddings</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span></span>
<span>  <span class="va">filenames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">IP</span>,<span class="st">"UMAP_to_RGB_log_"</span>,<span class="va">nfeatures</span>,<span class="st">"_"</span>,<span class="va">slideTag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">".csv"</span><span class="op">)</span></span>
<span>  <span class="fu">exportRGB.csv</span><span class="op">(</span><span class="va">count</span>,file <span class="op">=</span> <span class="va">filenames</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="image-array-creation">Image Array Creation<a class="anchor" aria-label="anchor" href="#image-array-creation"></a>
</h3>
<p>The next step uses the data frames generated above to build image
arrays. If you have saved the data frame above, you can directly load
that data frame. This function converts punctual coordinate locations
into tiles. Each tile is then rasterised to include all possible pixel
locations and assigned its colour code to it. We will only use one of
the arrays as an example. The analysis of both Slide-seq data is shown
below.</p>
<p>You will notice below that two of the arguments contain the key word
“filter”. <code>filterGrid</code> removes stray beads and
<code>filterThreshold</code> removes any tiles that might be to large
(i.e tiles that fill gaps in the ST assay).</p>
<p>The resolution argument changes the resolution of the output image.
Smaller Images decrease run time. The image resolution may be decreased
but all beads are still retained.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Loading saved data frame after PCA to RGB conversion</span></span>
<span><span class="co"># Replace countList[[i]] with this data frame</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co">#imageBrain &lt;- utils::read.csv("path/to/file.csv",header=T, stringsAsFactors=F)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Next we build the image</span></span>
<span><span class="co"># We recommend using more than one core.</span></span>
<span><span class="co"># Using first list element</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">buildImageArray</span><span class="op">(</span><span class="va">countList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                              filterGrid <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>                              filterThreshold <span class="op">=</span> <span class="fl">0.9975</span>,</span>
<span>                              resolution <span class="op">=</span> <span class="fl">40</span>,</span>
<span>                              cores <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="image-processing">Image processing<a class="anchor" aria-label="anchor" href="#image-processing"></a>
</h3>
<p>The first step in this section of the analysis will be to regularise
the image via <a href="https://cran.rstudio.com/web/packages/tvR/tvR.pdf" class="external-link">Total Variance
Regularisation</a>. Vesalius also offers the possibility to equalise
color histograms to increase contrast between territories. This process
is not always required and is better suited for PCA embeddings. See
section on PCA embeddings below.</p>
<p>The higher the lambda the smoother the output.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">regulariseImage</span><span class="op">(</span><span class="va">imageBrain</span>,</span>
<span>                              lambda <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                              niter <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                              normalise<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we will iteratively segment the image. This is achieved by
the <code>iterativeSegmentation.array</code> that offers quite a few
different options. As this function uses kmeans clustering to generate
color segments, the <code>colDepth</code> argument define the number of
final colour you wish to have. This function can take multiple values
for <code>colDepth</code>. Essentially, the image will first be smoothed
and then segmented into <code>k</code>colors. Then, another round of
smoothing will be applied followed by another round of segmentation.
This will be repeated for every value of <code>k</code>. In this
context, we highly recommend using a <code>colDepth</code> with
decreasing values (e.g. <code>seq(12,6, by = -2)</code>).</p>
<p><strong>Image smoothing is handle within the segmentation function.
If you wish to smooth independently, please use the
<code>smoothArray</code>function.</strong></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># colDepth = number of colour segments</span></span>
<span><span class="co"># smoothIter = number of smoothing rounds PRIOR to segmentation</span></span>
<span><span class="co"># methods = smoothing methods (they will be applied in the order they are given)</span></span>
<span><span class="co"># sigma = sigma for gaussian blur</span></span>
<span><span class="co"># box = size of median kernel</span></span>
<span><span class="co"># useCenter = we use only the centre pixel</span></span>
<span><span class="co"># invert = if colour should be inverted (if true then background is "white")</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span></span>
<span><span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">iterativeSegmentation.array</span><span class="op">(</span><span class="va">imageBrain</span>, colDepth <span class="op">=</span><span class="fl">11</span>,</span>
<span>                                          smoothIter <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                          method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iso"</span>,<span class="st">"box"</span><span class="op">)</span>,</span>
<span>                                          sigma<span class="op">=</span><span class="fl">1</span>,box <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                                          useCenter <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>The parameters selected during this process will affect the number
final territories. While case by case parameter selection would
optimised the final number of territories, we have noticed that these
parameters are more closely tied to ST method. We used the same
parameters for all data sets produced by the same ST method.</p>
</div>
<div class="section level3">
<h3 id="territory-isolation">Territory Isolation<a class="anchor" aria-label="anchor" href="#territory-isolation"></a>
</h3>
<p>Vesalius takes an image containing colour segments and further
separates them into distinct spatial territories. For each color
segment, beads are pooled into a territory as long as they are within a
certain <code>captureRadius</code> of other beads belonging to the same
colour segment. If there are still beads remaining in that color
segment, the process will be repeated until all beads have been pooled
into a territory. Vesalius also considers that territories that fall
under a certain threshold (defined by <code>minBar</code>) are isolated
territories. All Isolated territories will be pooled together.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># captureRadius = proportion of maximum distance between two beads.</span></span>
<span><span class="co"># minBar = minimum number of cells that should be in a territory</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">isolateTerritories.array</span><span class="op">(</span><span class="va">imageBrain</span>,</span>
<span>                                        captureRadius <span class="op">=</span> <span class="fl">0.008</span>,</span>
<span>                                        minBar <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="vesalius-image-and-territory-visualisation">Vesalius Image and Territory visualisation<a class="anchor" aria-label="anchor" href="#vesalius-image-and-territory-visualisation"></a>
</h3>
<p>Both image arrays and territories can be visualised using Vesalius
plotting functions. Please note that these functions are minimalistic:
we assume that users might want to use their own plotting style and this
is straight forward as the output of all Vesalius functions are simple
data frames. Feel free to use which ever tool you prefer to visualise
your data.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure 2a</strong></li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># IMPORTANT: the "split" show all territories separately - it just makes</span></span>
<span><span class="co"># visualisation and territory selection easier. Please refer to this plot</span></span>
<span><span class="co"># to select territories if in doubt.</span></span>
<span><span class="co"># If desired, each function will return a ggplot object that can be further</span></span>
<span><span class="co"># customised as demonstrated below.</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">imgSmoothed</span> <span class="op">&lt;-</span> <span class="fu">imagePlot</span><span class="op">(</span><span class="va">imageBrain</span>, as.cimg <span class="op">=</span> <span class="cn">F</span>,cex <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgSmoothed</span></span>
<span></span>
<span><span class="va">imgTerritory</span> <span class="op">&lt;-</span> <span class="fu">territoryPlot</span><span class="op">(</span><span class="va">imageBrain</span>, randomise <span class="op">=</span> <span class="cn">TRUE</span>,cex <span class="op">=</span><span class="fl">15</span> , cex.pt<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>         plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span><span class="fl">15</span><span class="op">)</span>,</span>
<span>         legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"vesalius_Territory.pdf"</span>, width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">imgTerritory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="isolating-vesalius-territories-for-in-depth-analysis">Isolating Vesalius Territories for in depth analysis<a class="anchor" aria-label="anchor" href="#isolating-vesalius-territories-for-in-depth-analysis"></a>
</h2>
<p>In this section, we will focus on the creation and manipulation of
Vesalius images in order to produce territories used for in depth
analysis. We are assuming that you have already run the embedding
functions and potentially saved the embeddings intermediate file.</p>
<div class="section level3">
<h3 id="slide-seqv2---mouse-hippocampus">Slide-SeqV2 - Mouse Hippocampus<a class="anchor" aria-label="anchor" href="#slide-seqv2---mouse-hippocampus"></a>
</h3>
<p>First, we load and process the mouse hippocampus data set taken from
Slide-Seq. We are using <em>Puck_200115_08</em> for this section of the
work.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Loading raw data into a Seurat object</span></span>
<span><span class="co"># Pre-processing count data</span></span>
<span><span class="co"># We keep a raw count seurat object to parse to DEG functions later on</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">bead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ReadSlideSeq.html" class="external-link">ReadSlideSeq</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08_bead_locations.csv"</span><span class="op">)</span></span>
<span><span class="va">brainRaw</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08.digital_expression.txt.gz"</span>, header <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">brainRaw</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">brainRaw</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">brainRaw</span> <span class="op">&lt;-</span> <span class="va">brainRaw</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">brainRaw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span><span class="va">brainRaw</span>, assay <span class="op">=</span><span class="st">"Spatial"</span><span class="op">)</span></span>
<span><span class="va">bead</span> <span class="op">&lt;-</span> <span class="va">bead</span><span class="op">[</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/Cells.html" class="external-link">Cells</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">brainRaw</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">bead</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span></span>
<span><span class="va">brainRaw</span><span class="op">[[</span><span class="st">"slice1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bead</span></span>
<span></span>
<span><span class="va">brainNorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">brainRaw</span><span class="op">)</span></span>
<span><span class="va">brainNorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">brainNorm</span>, nfeatures <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">brainNorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="va">brainNorm</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Loading and processing mouse hippocampus Slide-seqV2 data</span></span>
<span><span class="co"># If you have saved the intermediate data frame</span></span>
<span><span class="co"># you can load that file and parse that instead of countList[[1]]</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co">#imageBrain &lt;- utils::read.csv("~/group/slide_seqV2/IP/PCA_to_RGB_log_2000_slice1_Puck_200115_08.csv",</span></span>
<span><span class="co">#                              header=T, stringsAsFactors=F)</span></span>
<span></span>
<span><span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">buildImageArray</span><span class="op">(</span><span class="va">countList</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                              filterThreshold <span class="op">=</span> <span class="fl">0.9975</span>,</span>
<span>                              resolution <span class="op">=</span> <span class="fl">40</span>,</span>
<span>                              cores <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">regulariseImage</span><span class="op">(</span><span class="va">imageBrain</span>, lambda <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                              niter <span class="op">=</span> <span class="fl">50</span>, normalise<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">iterativeSegmentation.array</span><span class="op">(</span><span class="va">imageBrain</span>, colDepth <span class="op">=</span><span class="fl">11</span>,</span>
<span>                                          smoothIter <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                          method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iso"</span>,<span class="st">"box"</span><span class="op">)</span>,</span>
<span>                                          sigma<span class="op">=</span><span class="fl">1</span>,box <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                                          useCenter <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">isolateTerritories.array</span><span class="op">(</span><span class="va">imageBrain</span>,</span>
<span>                                        captureRadius <span class="op">=</span> <span class="fl">0.008</span>,</span>
<span>                                        minBar <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p>Once the data has been processed, we can select territories for in
depth analysis. We recommend using the <code>territoryPlot</code>
function with the <code>split</code> argument set to <code>TRUE</code>
to better visualise and select the desired territories. Here we will use
both raw counts and processed counts.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure 3a</strong></li>
<li><strong>Figure 3d</strong></li>
<li>DEG are included in supplementary material of the manuscript.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># seedID = numeric vector containing territories of interest</span></span>
<span><span class="co"># morphologyFactor = numeric vector used to apply any morpholgical operators</span></span>
<span><span class="co"># NOTE that positive value with inflate while negative values will erode.</span></span>
<span><span class="co"># CACluster = CA Pyramidal layer field</span></span>
<span><span class="co"># medCluster = Medial habenula and thrid ventricle</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span></span>
<span><span class="va">CACluster</span> <span class="op">&lt;-</span> <span class="fu">extractTerritories</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainRaw</span>,</span>
<span>                                seedID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span>,morphologyFactor<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">medCluster</span> <span class="op">&lt;-</span> <span class="fu">extractTerritories</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainRaw</span>,</span>
<span>                                 seedID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span><span class="op">)</span>,morphologyFactor<span class="op">=</span><span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Clustering analysis carried out by Seurat</span></span>
<span><span class="co"># Here we use the recommended pipeline as we are clustering barcodes and not</span></span>
<span><span class="co"># producing images.</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">CACluster</span> <span class="op">&lt;-</span> <span class="va">CACluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html" class="external-link">SCTransform</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Finding and extracting markers for each cluster (top 15 based on log FC)</span></span>
<span><span class="co"># This compares clusters between each other and does not consider all other</span></span>
<span><span class="co"># barcodes. Used for annotation.</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">CAMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html" class="external-link">FindAllMarkers</a></span><span class="op">(</span><span class="va">CACluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">avg_log2FC</span> <span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Extracting genes that are differentially expressed in the cluster</span></span>
<span><span class="co"># after comparing those barcodes to all other barcodes. This differs from</span></span>
<span><span class="co"># the section above as we are not only considering barcodes in the isolated</span></span>
<span><span class="co"># territory but all all other territories</span></span>
<span><span class="co"># As such, we use normalised count values (brainCounts was previously preprocessed)</span></span>
<span><span class="co"># Used for annotation.</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">CAClusterMarkers</span> <span class="op">&lt;-</span> <span class="fu">extractClusterMarkers</span><span class="op">(</span><span class="va">CACluster</span>,<span class="va">brainNorm</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">seedTerritory</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span><span class="fl">20</span>,wt <span class="op">=</span> <span class="va">logFC</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Custom plotting  with cell type annotation</span></span>
<span><span class="co"># Barcodes were annotated manually - see supplementary table 1 in manuscript</span></span>
<span><span class="co"># Colour comes from a colour blind friendly palette</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">CA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/FetchData.html" class="external-link">FetchData</a></span><span class="op">(</span><span class="va">CACluster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"UMAP_1"</span>,<span class="st">"UMAP_2"</span>,<span class="st">"seurat_clusters"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">CA_ISH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CA1 Pyramidal Layer"</span>,</span>
<span>            <span class="st">"Astrocyte"</span>,</span>
<span>            <span class="st">"CA3 Pyramidal Layer"</span>,</span>
<span>            <span class="st">"CA1 Pyramidal Layer"</span>,</span>
<span>            <span class="st">"Microglia"</span>,</span>
<span>            <span class="st">"Neuron"</span>,</span>
<span>            <span class="st">"CA2 Pyramidal Layer"</span>,</span>
<span>             <span class="st">"Oligodendrocyte"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coordCA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/GetTissueCoordinates.html" class="external-link">GetTissueCoordinates</a></span><span class="op">(</span><span class="va">CACluster</span><span class="op">)</span></span>
<span><span class="va">CA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">CA</span>,<span class="va">coordCA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lvls</span> <span class="op">&lt;-</span> <span class="va">CA_ISH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">CA</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">CA</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">&lt;-</span> <span class="va">lvls</span></span>
<span></span>
<span><span class="va">CA_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">CA</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#cols &lt;- c("#999999", "#E69F00", "#56B4E9", "#009E73",</span></span>
<span><span class="co">#          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")#[c(2,6,8,5,4)]</span></span>
<span><span class="va">ca_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,</span>
<span>                                <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu">ca_pal</span><span class="op">(</span><span class="va">CA_col</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">CA_col</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">coord_CA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">CA</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.4</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                  <span class="co">#axis.text = element_text(size = 20),</span></span>
<span>                  <span class="co">#axis.title = element_text(size = 20),</span></span>
<span>                  legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                  plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                  plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>                  plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">" "</span>, title <span class="op">=</span> <span class="st">" "</span>,</span>
<span>                x <span class="op">=</span> <span class="st">"X coordinates"</span>, y <span class="op">=</span> <span class="st">"Y coordinates"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># The same process is applied to the third ventricle and medial habenula</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">medCluster</span> <span class="op">&lt;-</span> <span class="va">medCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html" class="external-link">SCTransform</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">medCluster</span> <span class="op">&lt;-</span> <span class="va">medCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span><span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">0.85</span><span class="op">)</span></span>
<span></span>
<span><span class="va">medMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html" class="external-link">FindAllMarkers</a></span><span class="op">(</span><span class="va">medCluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">avg_log2FC</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">medClusterMarkers</span> <span class="op">&lt;-</span> <span class="fu">extractClusterMarkers</span><span class="op">(</span><span class="va">medCluster</span>,<span class="va">brainNorm</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">seedTerritory</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span><span class="fl">25</span>,wt <span class="op">=</span> <span class="va">logFC</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Here we compare cluster between each other and more specifically clusters</span></span>
<span><span class="co"># associated with the medial habenula and the third ventricle.</span></span>
<span><span class="co"># This is where we get compartment specific gene expression</span></span>
<span><span class="co"># medComp = medial habenula</span></span>
<span><span class="co"># tvCompt = third ventricle</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">medComp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html" class="external-link">FindMarkers</a></span><span class="op">(</span><span class="va">medCluster</span>,ident.1 <span class="op">=</span> <span class="fl">0</span>, ident.2 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">tvCompt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html" class="external-link">FindMarkers</a></span><span class="op">(</span><span class="va">medCluster</span>,ident.1 <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">8</span><span class="op">)</span>,ident.2<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#EpendymalComp &lt;- FindMarkers(medCluster,ident.1 =1,ident.2=6)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Plotting</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/FetchData.html" class="external-link">FetchData</a></span><span class="op">(</span><span class="va">medCluster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"UMAP_1"</span>,<span class="st">"UMAP_2"</span>,<span class="st">"seurat_clusters"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">med_ISH</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Medial Habenula - Low"</span>,</span>
<span>            <span class="st">"Third Ventricle - Low"</span>,</span>
<span>             <span class="st">"Third Ventricle - High"</span>,</span>
<span>              <span class="st">"Endothelial Cells"</span>,</span>
<span>              <span class="st">"Third Ventricle - High"</span>,</span>
<span>              <span class="st">"Medial Habenula - High"</span>,</span>
<span>              <span class="st">"Ependymal"</span>,</span>
<span>              <span class="st">"Microglia"</span>,</span>
<span>              <span class="st">"Oligodendrocyte"</span>,</span>
<span>              <span class="st">"Oligodendrocyte"</span><span class="op">)</span></span>
<span><span class="va">coordmed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/GetTissueCoordinates.html" class="external-link">GetTissueCoordinates</a></span><span class="op">(</span><span class="va">medCluster</span><span class="op">)</span></span>
<span><span class="va">med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">med</span>,<span class="va">coordmed</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">lvls</span> <span class="op">&lt;-</span> <span class="va">med_ISH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">med</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">med</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">&lt;-</span> <span class="va">lvls</span></span>
<span></span>
<span><span class="va">med_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">med</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">med_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,</span>
<span>                                <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu">med_pal</span><span class="op">(</span><span class="va">med_col</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">med_col</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">coord_med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">med</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                  legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                  <span class="co">#axis.text = element_text(size = 20),</span></span>
<span>                  <span class="co">#axis.title = element_text(size = 20),,</span></span>
<span>                  plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                  plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>                  plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">" "</span>, title <span class="op">=</span> <span class="st">""</span>,</span>
<span>                x <span class="op">=</span> <span class="st">"X coordinates"</span>, y <span class="op">=</span> <span class="st">"Y coordinates"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can visualise cell clustering in isolated territories</p>
<ul>
<li><strong>Figure 3a</strong></li>
<li><strong>Figure 3d</strong></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#pdf("SSV2_Brain_IsolatedTerritory.pdf", width = 10, height= 5)</span></span>
<span><span class="va">coord_CA</span> <span class="op">/</span> <span class="va">coord_med</span></span>
<span><span class="co">#dev.off()</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="slide-seqv2---mouse-embryo-e12-5">Slide-SeqV2 - Mouse Embryo (E12.5)<a class="anchor" aria-label="anchor" href="#slide-seqv2---mouse-embryo-e12-5"></a>
</h3>
<p>We applied the same principles in the mouse embryo as in the mouse
hippocampus. Here, we are using <em>Puck_190926_03</em>. If you have not
saved the RGB embedding file please run the embedding section first and
substitute object/files accordingly.</p>
<p>The following section produces:</p>
<ul>
<li><strong>Figure 2c</strong></li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ReadSlideSeq.html" class="external-link">ReadSlideSeq</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_190926_03_bead_locations.csv"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">embryoCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_190926_03.digital_expression.txt.gz"</span>, header <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">embryoCounts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">embryoCounts</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">embryoCounts</span> <span class="op">&lt;-</span> <span class="va">embryoCounts</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">embryoCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span><span class="va">embryoCounts</span>, assay <span class="op">=</span><span class="st">"Spatial"</span><span class="op">)</span></span>
<span><span class="va">bead</span> <span class="op">&lt;-</span> <span class="va">bead</span><span class="op">[</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/Cells.html" class="external-link">Cells</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">embryoCounts</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">bead</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span></span>
<span><span class="va">embryoCounts</span><span class="op">[[</span><span class="st">"slice1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bead</span></span>
<span><span class="va">embryoNorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">embryoCounts</span><span class="op">)</span></span>
<span><span class="va">embryoNorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">embryoNorm</span>, nfeatures <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">embryoNorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="va">embryoNorm</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#imageEmbryo &lt;- utils::read.csv("~/group/slide_seqV2/IP/PCA_to_RGB_log_2000_slice1_Puck_190926_03.csv",</span></span>
<span><span class="co">#                                 header=T, stringsAsFactors=F)</span></span>
<span></span>
<span><span class="va">imageEmbryo</span> <span class="op">&lt;-</span> <span class="fu">buildImageArray</span><span class="op">(</span><span class="va">countList</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                               filterThreshold <span class="op">=</span> <span class="fl">0.999</span>,</span>
<span>                               resolution <span class="op">=</span> <span class="fl">40</span>,</span>
<span>                               cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#imageEmbryo &lt;- equalizeHistogram(imageEmbryo,</span></span>
<span><span class="co">#                                 sleft = 2.5, sright = 2.5,invert = T)</span></span>
<span></span>
<span></span>
<span><span class="va">imageEmbryo</span> <span class="op">&lt;-</span> <span class="fu">regulariseImage</span><span class="op">(</span><span class="va">imageEmbryo</span>,lambda <span class="op">=</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">imageEmbryo</span> <span class="op">&lt;-</span> <span class="fu">iterativeSegmentation.array</span><span class="op">(</span><span class="va">imageEmbryo</span>,</span>
<span>                                           colDepth <span class="op">=</span> <span class="fl">12</span>,</span>
<span>                                           smoothIter <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                                           method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"iso"</span>,<span class="st">"box"</span><span class="op">)</span>,</span>
<span>                                           sigma <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                           box <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                                           useCenter<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">imageEmbryo</span> <span class="op">&lt;-</span> <span class="fu">isolateTerritories.array</span><span class="op">(</span><span class="va">imageEmbryo</span>,</span>
<span>                                        captureRadius <span class="op">=</span> <span class="fl">0.025</span>,minBar <span class="op">=</span> <span class="fl">40</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co">#----------------------------------------------------------------------------#</span></span>
<span><span class="co"># Finally some plotting - Figure 2c</span></span>
<span><span class="co">#----------------------------------------------------------------------------#</span></span>
<span><span class="va">imgSmoothedEm</span> <span class="op">&lt;-</span> <span class="fu">imagePlot</span><span class="op">(</span><span class="va">imageEmbryo</span>, as.cimg <span class="op">=</span> <span class="cn">F</span>,cex <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">imgTerritoryEm</span> <span class="op">&lt;-</span> <span class="fu">territoryPlot</span><span class="op">(</span><span class="va">imageEmbryo</span>, randomise <span class="op">=</span> <span class="cn">TRUE</span>,cex <span class="op">=</span><span class="fl">15</span> , cex.pt<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>                          legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>                          plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Slide-seq V2 - Embryo (E12.5)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Embryo.pdf"</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">7</span>, height<span class="op">=</span><span class="fl">5.5</span><span class="op">)</span></span>
<span><span class="va">imgTerritoryEm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>In the embryo, we isolated the eye for in depth analysis. The
principles applied in hippocampus still apply here. The DEG are included
in the supplementary material of the manuscript.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Extract territories</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span></span>
<span><span class="va">eyeCluster</span> <span class="op">&lt;-</span> <span class="fu">extractTerritories</span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">embryoCounts</span>,seedID <span class="op">=</span> <span class="fl">17</span>,morphologyFactor<span class="op">=</span><span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Eye analysis</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">eyeCluster</span> <span class="op">&lt;-</span> <span class="va">eyeCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html" class="external-link">SCTransform</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">eyeCluster</span> <span class="op">&lt;-</span> <span class="va">eyeCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Embryonic eye markers</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">eyeMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html" class="external-link">FindAllMarkers</a></span><span class="op">(</span><span class="va">eyeCluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">avg_log2FC</span> <span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eyeClusterMarkers</span> <span class="op">&lt;-</span> <span class="fu">extractClusterMarkers</span><span class="op">(</span><span class="va">eyeCluster</span>,<span class="va">embryoNorm</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">seedTerritory</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span><span class="fl">30</span>,wt <span class="op">=</span> <span class="va">logFC</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Here we compare cluster between each other and more specifically clusters</span></span>
<span><span class="co"># associated with different cell type layers in the embryonic eye.</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">epiComp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html" class="external-link">FindMarkers</a></span><span class="op">(</span><span class="va">eyeCluster</span>,ident.1 <span class="op">=</span> <span class="fl">1</span>, ident.2 <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">lensComp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html" class="external-link">FindMarkers</a></span><span class="op">(</span><span class="va">eyeCluster</span>,ident.1 <span class="op">=</span><span class="fl">4</span>,ident.2<span class="op">=</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Plotting and Assigning cell types</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">eye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/FetchData.html" class="external-link">FetchData</a></span><span class="op">(</span><span class="va">eyeCluster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"UMAP_1"</span>,<span class="st">"UMAP_2"</span>,<span class="st">"seurat_clusters"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">eye_ISH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Periocular Mesenchyme"</span>,</span>
<span>             <span class="st">"Anterior Lens Epithelial Cells"</span>,</span>
<span>             <span class="st">"Primary Lens Fiber Cells"</span>,</span>
<span>             <span class="st">"Anterior Lens Epithelial Cells - L2"</span>,</span>
<span>             <span class="st">"Lens Vesicle Cells"</span>,</span>
<span>             <span class="st">"Lens Vesicle Cells - L2"</span>,</span>
<span>             <span class="st">"Preplacodal Lens Ectoderm"</span>,</span>
<span>             <span class="st">"Primary Lens Fiber Cells"</span>,</span>
<span>             <span class="st">"Macrophage"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coordeye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/GetTissueCoordinates.html" class="external-link">GetTissueCoordinates</a></span><span class="op">(</span><span class="va">eyeCluster</span><span class="op">)</span></span>
<span><span class="va">eye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">eye</span>,<span class="va">coordeye</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lvls</span> <span class="op">&lt;-</span> <span class="va">eye_ISH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">eye</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">eye</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">&lt;-</span> <span class="va">lvls</span></span>
<span></span>
<span><span class="va">eye_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">eye</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eye_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,</span>
<span>                                <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu">eye_pal</span><span class="op">(</span><span class="va">eye_col</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">eye_col</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">coord_eye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">eye</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                   legend.position <span class="op">=</span><span class="st">"right"</span>,</span>
<span>                   plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                   plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>                   plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">""</span>, title <span class="op">=</span> <span class="st">""</span>,</span>
<span>                                x <span class="op">=</span> <span class="st">"X coordinates"</span>, y <span class="op">=</span> <span class="st">"Y coordinates"</span><span class="op">)</span></span></code></pre></div>
<p>We can visualise the isolated eye.</p>
<p><strong>Figure 3g</strong></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coord_eye</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="seqscope---liver">SeqScope - Liver<a class="anchor" aria-label="anchor" href="#seqscope---liver"></a>
</h3>
<p>Vesalius is able to handle any type of spatial transcriptomic data as
long as there are coordinates and gene counts provided. Here, we
demonstrate Vesalius ability to recover tissue territories in another
high resolution Spatial transcriptomics assay SeqScope. SeqScope data is
available <a href="https://deepblue.lib.umich.edu/data/concern/data_sets/9c67wn05f" class="external-link">here</a>.
The SeqScope team provide process spatial data sets in the form of
<code>.rds</code>files containing Seurat objects as well as H&amp;E
images. An important aspect to consider when working with these
datasets, is that they may contain more than one “slice”. As each data
set has already been pre-processed, we do not need to pre-process the
data again.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure 2e</strong></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Load data set</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">seq</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"~/group/seqScope/Liver_TD_10um_annotated.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Converting to RGB</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">seq</span> <span class="op">&lt;-</span> <span class="fu">rgbUMAP</span><span class="op">(</span>SO <span class="op">=</span> <span class="va">seq</span>, conserveSparse<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Reducing coordinates size</span></span>
<span><span class="co"># There is a lot of space between coordinates that is not required</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">seq</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">seq</span><span class="op">$</span><span class="va">x</span><span class="op">/</span><span class="fl">10</span></span>
<span><span class="va">seq</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">seq</span><span class="op">$</span><span class="va">y</span><span class="op">/</span><span class="fl">10</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Build Image and process</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">image</span> <span class="op">&lt;-</span> <span class="fu">buildImageArray</span><span class="op">(</span><span class="va">seq</span>,sliceID<span class="op">=</span><span class="fl">1</span>,resolution<span class="op">=</span><span class="fl">30</span>,filterThreshold<span class="op">=</span><span class="fl">0.99</span>, cores<span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">tmpImage</span> <span class="op">&lt;-</span> <span class="fu">equalizeHistogram</span><span class="op">(</span><span class="va">image</span>, sleft <span class="op">=</span> <span class="fl">2.5</span> , sright <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="va">tmpImage</span> <span class="op">&lt;-</span> <span class="fu">regulariseImage</span><span class="op">(</span><span class="va">tmpImage</span>, lambda <span class="op">=</span> <span class="fl">10</span>,invert <span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">tmpImage</span> <span class="op">&lt;-</span> <span class="fu">iterativeSegmentation.array</span><span class="op">(</span><span class="va">tmpImage</span>,colDepth <span class="op">=</span> <span class="fl">9</span>,</span>
<span>  smoothIter <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"box"</span>,<span class="st">"iso"</span><span class="op">)</span>,</span>
<span>  acrossLevels <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>  box <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  useCenter <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">tmpImage</span> <span class="op">&lt;-</span> <span class="fu">isolateTerritories.array</span><span class="op">(</span><span class="va">tmpImage</span>,minBar<span class="op">=</span><span class="fl">5</span>,captureRadius <span class="op">=</span> <span class="fl">0.035</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Get single slice for plotting example</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">plotTmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tmpImage</span>, <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">800</span> <span class="op">&amp;</span> <span class="va">x</span> <span class="op">&lt;</span> <span class="fl">1700</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">plotTmp</span><span class="op">$</span><span class="va">territory</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="va">plotTmp</span><span class="op">$</span><span class="va">territory</span><span class="op">[</span><span class="va">plotTmp</span><span class="op">$</span><span class="va">territory</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">plotTmp</span><span class="op">$</span><span class="va">territory</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"seqScopeTerLiver.pdf"</span>, width <span class="op">=</span> <span class="fl">7</span>, height<span class="op">=</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span><span class="fu">territoryPlot</span><span class="op">(</span><span class="va">plotTmp</span>,cex <span class="op">=</span> <span class="fl">15</span>,cex.pt<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>         plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span><span class="fl">15</span><span class="op">)</span>,</span>
<span>         legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour<span class="op">=</span> <span class="st">"Territory nr."</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="seqscope---colon">SeqScope - Colon<a class="anchor" aria-label="anchor" href="#seqscope---colon"></a>
</h3>
<p>We can apply the same process as described above but for the SeqScope
Colon data set. The <code>.rds</code> files also contains more than one
slice.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure 2f</strong></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Load data set</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">seq</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"~/group/seqScope/Colon_10um_annotated.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Converting to RGB</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">seq</span> <span class="op">&lt;-</span> <span class="fu">rgbUMAP</span><span class="op">(</span>SO <span class="op">=</span> <span class="va">seq</span>, conserveSparse<span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Reducing coordinates size</span></span>
<span><span class="co"># There is a lot of space between coordinates that is not required</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">seq</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">seq</span><span class="op">$</span><span class="va">x</span><span class="op">/</span><span class="fl">10</span></span>
<span><span class="va">seq</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">seq</span><span class="op">$</span><span class="va">y</span><span class="op">/</span><span class="fl">10</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Build Image and process</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">image</span> <span class="op">&lt;-</span> <span class="fu">buildImageArray</span><span class="op">(</span><span class="va">seq</span>,sliceID<span class="op">=</span><span class="fl">1</span>,resolution<span class="op">=</span><span class="fl">30</span>,filterThreshold<span class="op">=</span><span class="fl">0.99</span>, cores<span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">tmpImage</span> <span class="op">&lt;-</span> <span class="fu">equalizeHistogram</span><span class="op">(</span><span class="va">image</span>, sleft <span class="op">=</span> <span class="fl">2.5</span> , sright <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="va">tmpImage</span> <span class="op">&lt;-</span> <span class="fu">regulariseImage</span><span class="op">(</span><span class="va">tmpImage</span>, lambda <span class="op">=</span> <span class="fl">10</span>,invert <span class="op">=</span><span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">tmpImage</span> <span class="op">&lt;-</span> <span class="fu">iterativeSegmentation.array</span><span class="op">(</span><span class="va">tmpImage</span>,colDepth <span class="op">=</span> <span class="fl">9</span>,</span>
<span>  smoothIter <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"box"</span>,<span class="st">"iso"</span><span class="op">)</span>,</span>
<span>  acrossLevels <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>  box <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  useCenter <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">tmpImage</span> <span class="op">&lt;-</span> <span class="fu">isolateTerritories.array</span><span class="op">(</span><span class="va">tmpImage</span>,minBar<span class="op">=</span><span class="fl">5</span>,captureRadius <span class="op">=</span> <span class="fl">0.035</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Get single slice for plotting example</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span></span>
<span><span class="va">plotTmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tmpImage</span>, <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">4500</span> <span class="op">&amp;</span> <span class="va">y</span> <span class="op">&gt;</span><span class="fl">900</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">plotTmp</span><span class="op">$</span><span class="va">territory</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="va">plotTmp</span><span class="op">$</span><span class="va">territory</span><span class="op">[</span><span class="va">plotTmp</span><span class="op">$</span><span class="va">territory</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">plotTmp</span><span class="op">$</span><span class="va">territory</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"seqScopeTerColon.pdf"</span>, width <span class="op">=</span> <span class="fl">7</span>, height<span class="op">=</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">g1</span> <span class="op">&lt;-</span><span class="fu">territoryPlot</span><span class="op">(</span><span class="va">plotTmp</span>,cex <span class="op">=</span> <span class="fl">15</span>,cex.pt<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,</span>
<span>         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,</span>
<span>         plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span><span class="fl">15</span><span class="op">)</span>,</span>
<span>         legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour<span class="op">=</span> <span class="st">"Territory nr."</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">g1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="visualising-gene-expression-patterns-">Visualising Gene expression patterns.<a class="anchor" aria-label="anchor" href="#visualising-gene-expression-patterns-"></a>
</h2>
<div class="section level3">
<h3 id="expression-pattern-in-the-isolated-ca-field">Expression Pattern in the isolated CA Field<a class="anchor" aria-label="anchor" href="#expression-pattern-in-the-isolated-ca-field"></a>
</h3>
<p>We showed that we recovered the CA2 field in isolated CA territory.
This was due to the fact that we could recover subtle gene expression
patterns that were otherwise lost or overshadowed by stronger patterns.
In this section, we show how we can visualise these expression
patterns.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure 3c</strong></li>
<li><strong>Figure S19</strong></li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># First we show the overall and isolated pattern for pcp4 (Fig 3)</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span></span>
<span><span class="va">pcp4All</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainNorm</span>,</span>
<span>                              ter <span class="op">=</span> <span class="cn">NULL</span>, genes <span class="op">=</span> <span class="st">"Pcp4"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'bottom'</span>,</span>
<span>                 plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">pcp4</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">CACluster</span>, genes <span class="op">=</span> <span class="st">"Pcp4"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'bottom'</span>,</span>
<span>              plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"pcp4.pdf"</span>,width<span class="op">=</span><span class="fl">5</span>,height<span class="op">=</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">pcp4All</span></span>
<span><span class="va">pcp4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Next we do the same thing for other CA2 marker genes (Fig SX)</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">rgs14All</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainCounts</span>,</span>
<span>                              ter <span class="op">=</span> <span class="cn">NULL</span>, genes <span class="op">=</span> <span class="st">"Rgs14"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'left'</span>,</span>
<span>            plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rgs14</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">CACluster</span>,</span>
<span>                            genes <span class="op">=</span> <span class="st">"Rgs14"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'left'</span>,</span>
<span>               plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">necab2All</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainCounts</span>,</span>
<span>                                ter <span class="op">=</span> <span class="cn">NULL</span>, genes <span class="op">=</span> <span class="st">"Necab2"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'right'</span>,</span>
<span>                   plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">necab2</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">CACluster</span>,</span>
<span>                             genes <span class="op">=</span> <span class="st">"Necab2"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'right'</span>,</span>
<span>                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"CA2_inClust_overall.pdf"</span>,width <span class="op">=</span> <span class="fl">10</span>,height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">rgs14All</span> <span class="op">+</span> <span class="va">necab2All</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">2</span>,nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"CA2_inClust.pdf"</span>,width <span class="op">=</span> <span class="fl">10</span>,height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">rgs14</span> <span class="op">+</span> <span class="va">necab2</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">2</span>,nrow <span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="expression-patterns-in-the-isolated-eye">Expression Patterns in the Isolated Eye<a class="anchor" aria-label="anchor" href="#expression-patterns-in-the-isolated-eye"></a>
</h3>
<p>We can also visualise differentially expressed genes between layers
in the eye.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure 3h</strong></li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Cryba4</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">eyeCluster</span>,</span>
<span>                             genes <span class="op">=</span> <span class="st">"Cryba4"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'none'</span>,</span>
<span>                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">Ccnd2</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">eyeCluster</span>,</span>
<span>                             genes <span class="op">=</span> <span class="st">"Ccnd2"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'right'</span>,</span>
<span>                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">Pmel</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">eyeCluster</span>,</span>
<span>                             genes <span class="op">=</span> <span class="st">"Pmel"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'none'</span>,</span>
<span>                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">Aldh1a1</span> <span class="op">&lt;-</span> <span class="fu">viewGeneExpression</span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">eyeCluster</span>,</span>
<span>                             genes <span class="op">=</span> <span class="st">"Aldh1a1"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'right'</span>,</span>
<span>                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"Eye_patterns.pdf"</span>, width <span class="op">=</span> <span class="fl">5</span>,height <span class="op">=</span><span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Cryba4</span><span class="op">+</span><span class="va">Ccnd2</span><span class="op">+</span><span class="va">Pmel</span> <span class="op">+</span><span class="va">Aldh1a1</span> <span class="op">+</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="territory-specific-expression-patterns-within-cell-types">Territory specific expression patterns within cell types<a class="anchor" aria-label="anchor" href="#territory-specific-expression-patterns-within-cell-types"></a>
</h2>
<p>Thanks to easy territory isolation, Vesalius can easily compare the
expression of cells between different anatomical structures. Here, we
present how we compared the expression of different cell types between
anatomical structures in the mouse hippocampus. The data is taken from
<em>Puck_200115_08</em>. First, we need to assign cell types to each
barcode. In this instance, we used <a href="https://github.com/dmcable/spacexr" class="external-link">RCTD</a> to decompose cell
types contained within each barcode and store annotations into a Seurat
object.</p>
<p><em>You do not need to use RCTD - you only need to assign cell types
to the barcodes contained in your data. Feel free to use any type of
annotation tool you prefer. The code shown here applies to Seurat
objects</em></p>
<p>First, we load our Seurat Object and extract homotypic barcodes.
Homotypic barcodes represent barcodes only containing a single cell type
according to RCTD.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"/isilonsund/NextGenSeqData/project-data/hkim/ST_project/Slide-seq/Slide-seq_hippocampus.rds"</span><span class="op">)</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">ref</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">celltype</span>, <span class="st">"\\+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">homo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">cells</span>,<span class="st">"+"</span>,<span class="va">cells</span><span class="op">)</span></span>
<span><span class="va">homo_cells</span> <span class="op">&lt;-</span> <span class="va">ref</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[</span><span class="va">ref</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">celltype</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">homo</span>,<span class="op">]</span></span>
<span><span class="va">homo_cells</span><span class="op">$</span><span class="va">barcodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">homo_cells</span><span class="op">)</span></span>
<span><span class="va">homo_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">homo_cells</span><span class="op">$</span><span class="va">barcodes</span>,<span class="va">homo_cells</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span></span></code></pre></div>
<p>Next, we can select territories of interest. For this example, we
compared the Cortex and the Thalamus. Note that the numerical values are
the Vesalius territories you wish to select. We recommend checking the
<code>territoryPlot</code> of your ST assay in split mode to select your
territories.</p>
<p>We will run the comparison on all homotypic beads. Not all cell type
combinations will yield differential gene expression.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure 4a</strong></li>
<li>DEGs are provided in the supplementary material of the
manuscript</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cortex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>,<span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">thalamus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28</span>,<span class="fl">33</span><span class="op">)</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># looping over all cells types in homotypic beads</span></span>
<span><span class="co"># Keeping everything in a neat little data frame</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">by_cell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">homo_cells</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">by_cell</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">homo_cells</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">homo_cells</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">homo_cells</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">homo_cells</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw">next</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">deg</span> <span class="op">&lt;-</span> <span class="fu">compareCells</span><span class="op">(</span><span class="va">imageBrain</span>,</span>
<span>                          <span class="va">brainNorm</span>,</span>
<span>                          <span class="va">homo_cells</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                          method <span class="op">=</span><span class="st">"wilcox"</span>,</span>
<span>                          seed<span class="op">=</span><span class="va">cortex</span>,</span>
<span>                          logFC <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>                          pval <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>                          query<span class="op">=</span><span class="va">thalamus</span>,</span>
<span>                          minBar <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">deg</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="kw">next</span><span class="op">(</span><span class="op">)</span><span class="op">}</span></span>
<span>    <span class="va">deg</span><span class="op">$</span><span class="va">celltype</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">homo_cells</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">deg</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">deg</span><span class="op">$</span><span class="va">group_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Cortex"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">deg</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">deg</span><span class="op">$</span><span class="va">group_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Thalamus"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">deg</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">by_cell</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">deg</span></span>
<span><span class="op">}</span></span>
<span><span class="va">by_cell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>,<span class="va">by_cell</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">by_cell</span>, file <span class="op">=</span> <span class="st">"vesalius_terComp_CortexVSThalamus.csv"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can plot the results. First, we plot all differentially
expressed genes and from these we will select two examples.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Plot everything</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">up</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co">#pdf("All_genes_Vesalius_diff_territory.pdf",width =20, height=20)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"diffTer/All_genes_Vesalius_diff_territory"</span>,<span class="va">j</span>,<span class="st">".png"</span><span class="op">)</span>,width <span class="op">=</span> <span class="fl">2000</span>,height<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span>  <span class="co"># Make the panel</span></span>
<span>  <span class="va">plotCols</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span>  <span class="va">plotRows</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span></span>
<span>  <span class="co"># Set up the page</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html" class="external-link">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/viewports.html" class="external-link">pushViewport</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span>layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.layout.html" class="external-link">grid.layout</a></span><span class="op">(</span><span class="va">plotRows</span>, <span class="va">plotCols</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">vplayout</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span>layout.pos.row <span class="op">=</span> <span class="va">x</span>, layout.pos.col <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Make each plot, in the correct location</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">curRow</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">i</span><span class="op">/</span><span class="va">plotCols</span><span class="op">)</span></span>
<span>      <span class="va">curCol</span> <span class="op">=</span> <span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">plotCols</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>      <span class="va">bar</span> <span class="op">&lt;-</span> <span class="va">homo_cells</span><span class="op">[[</span><span class="va">by_cell</span><span class="op">$</span><span class="va">celltype</span><span class="op">[</span><span class="va">up</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">gene</span> <span class="op">&lt;-</span> <span class="va">by_cell</span><span class="op">$</span><span class="va">genes</span><span class="op">[</span><span class="va">up</span><span class="op">]</span></span>
<span>      <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">viewCellExpression</span><span class="op">(</span>image <span class="op">=</span> <span class="va">imageBrain</span> ,</span>
<span>          counts <span class="op">=</span> <span class="va">brainNorm</span>,</span>
<span>          cells <span class="op">=</span> <span class="va">bar</span>,</span>
<span>          gene <span class="op">=</span> <span class="va">gene</span>,</span>
<span>          ter1 <span class="op">=</span><span class="va">cortex</span>,ter2<span class="op">=</span><span class="va">thalamus</span>,</span>
<span>          cex <span class="op">=</span><span class="fl">17</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">by_cell</span><span class="op">$</span><span class="va">celltype</span><span class="op">[</span><span class="va">up</span><span class="op">]</span>,<span class="st">"-"</span>,<span class="va">gene</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span>, vp <span class="op">=</span> <span class="fu">vplayout</span><span class="op">(</span><span class="va">curRow</span>, <span class="va">curCol</span> <span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">up</span> <span class="op">&lt;-</span> <span class="va">up</span> <span class="op">+</span><span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Selecting examples to plot Figure 4a</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"vesalius_DEG_between_Ter.pdf"</span>,height <span class="op">=</span> <span class="fl">5</span>,width <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Cpe in astrocytes</span></span>
<span><span class="va">local</span> <span class="op">&lt;-</span> <span class="va">by_cell</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">genes</span> <span class="op">==</span> <span class="st">"Cpe"</span> <span class="op">&amp;</span> <span class="va">celltype</span> <span class="op">==</span> <span class="st">"Astrocyte+Astrocyte"</span><span class="op">)</span></span>
<span><span class="va">bar</span> <span class="op">&lt;-</span> <span class="va">homo_cells</span><span class="op">[[</span><span class="st">"Astrocyte+Astrocyte"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">viewCellExpression</span><span class="op">(</span>image <span class="op">=</span> <span class="va">imageBrain</span> ,</span>
<span>        counts <span class="op">=</span> <span class="va">brainNorm</span>,</span>
<span>        cells <span class="op">=</span> <span class="va">bar</span>,</span>
<span>        gene <span class="op">=</span> <span class="va">local</span><span class="op">$</span><span class="va">genes</span>,</span>
<span>        ter1 <span class="op">=</span><span class="va">cortex</span>,ter2<span class="op">=</span><span class="va">thalamus</span>,</span>
<span>        normalise <span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>        cex <span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Astrocyte - Cpe"</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_shape.html" class="external-link">scale_shape_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cortex"</span>, <span class="st">"Thalamus"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Nrgn in Entorhinal</span></span>
<span><span class="va">local</span> <span class="op">&lt;-</span> <span class="va">by_cell</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">genes</span> <span class="op">==</span> <span class="st">"Nrgn"</span> <span class="op">&amp;</span> <span class="va">celltype</span> <span class="op">==</span> <span class="st">"Entorhinal+Entorhinal"</span><span class="op">)</span></span>
<span><span class="va">bar</span> <span class="op">&lt;-</span> <span class="va">homo_cells</span><span class="op">[[</span><span class="st">"Entorhinal+Entorhinal"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">viewCellExpression</span><span class="op">(</span>image <span class="op">=</span> <span class="va">imageBrain</span> ,</span>
<span>        counts <span class="op">=</span> <span class="va">brainNorm</span>,</span>
<span>        cells <span class="op">=</span> <span class="va">bar</span>,</span>
<span>        gene <span class="op">=</span> <span class="va">local</span><span class="op">$</span><span class="va">genes</span>,</span>
<span>        ter1 <span class="op">=</span><span class="va">cortex</span>,ter2<span class="op">=</span><span class="va">thalamus</span>,</span>
<span>        normalise <span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>        cex <span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Entorhinal - Nrgn"</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_shape.html" class="external-link">scale_shape_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cortex"</span>, <span class="st">"Thalamus"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="va">p1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tissue-border-expression">Tissue border expression<a class="anchor" aria-label="anchor" href="#tissue-border-expression"></a>
</h2>
<p>The isolation of territories in combination with the image
representation of territories makes for an easy way to analyse gene
expression pattern at the border between different tissues. For example,
we analysed the expression patterns at the border between the Dentate
Gyrus Granule Cell Layer and the Dentate Gyrus Sub Granular Zone.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure 4b</strong></li>
<li>DEGs are provided in the supplementary material of the
manuscript</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Get territory and run clustering</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">DenCluster</span> <span class="op">&lt;-</span> <span class="fu">extractTerritories</span><span class="op">(</span><span class="va">imageBrain</span>, <span class="va">brainRaw</span>,</span>
<span>                                 seedID <span class="op">=</span> <span class="fl">26</span>,morphologyFactor <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DenCluster</span> <span class="op">&lt;-</span> <span class="va">DenCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html" class="external-link">SCTransform</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># We can extract marker gene from each cluster and compare each cluster</span></span>
<span><span class="co"># to all other territories</span></span>
<span><span class="co"># NOTE: for cell type annotation we used anatomical position as we just wanted</span></span>
<span><span class="co"># overall territory not specific cell types</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">denMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html" class="external-link">FindAllMarkers</a></span><span class="op">(</span><span class="va">DenCluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span><span class="fl">25</span>,wt<span class="op">=</span><span class="va">avg_log2FC</span><span class="op">)</span></span>
<span></span>
<span><span class="va">denClusterMarkers</span> <span class="op">&lt;-</span> <span class="fu">extractClusterMarkers</span><span class="op">(</span><span class="va">DenCluster</span>,<span class="va">brainCounts</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">seedTerritory</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span><span class="fl">15</span>,wt <span class="op">=</span> <span class="va">logFC</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># We now have all the data we need to do some plotting</span></span>
<span><span class="co"># We start off with the clustered dentate gyrus</span></span>
<span><span class="co"># We only show the coordinates</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span></span>
<span><span class="va">outer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/FetchData.html" class="external-link">FetchData</a></span><span class="op">(</span><span class="va">DenCluster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"UMAP_1"</span>,<span class="st">"UMAP_2"</span>,<span class="st">"seurat_clusters"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">coordouter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/GetTissueCoordinates.html" class="external-link">GetTissueCoordinates</a></span><span class="op">(</span><span class="va">DenCluster</span><span class="op">)</span></span>
<span><span class="va">outer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">outer</span>,<span class="va">coordouter</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outer_ISH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DG - Granule Cell Layer"</span>,</span>
<span>               <span class="st">"DG - Granule Cell Layer"</span>,</span>
<span>               <span class="st">"DG - Sub-Granular Zone"</span>,</span>
<span>                <span class="st">"DG - Molecular Layer"</span>,</span>
<span>              <span class="st">"DG - Granule Cell Layer"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lvls</span> <span class="op">&lt;-</span> <span class="va">outer_ISH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">outer</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">outer</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">&lt;-</span> <span class="va">lvls</span></span>
<span><span class="va">outer_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">outer</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#outer_pal &lt;- colorRampPalette(c("#999999", "#E69F00", "#56B4E9", "#009E73",</span></span>
<span>                                <span class="co">#"#F0E442", "#0072B2", "#D55E00", "#CC79A7"))</span></span>
<span><span class="co">#cols &lt;- outer_pal(outer_col)[sample(1:outer_col)]</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,</span>
<span>         <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">coord_outer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">outer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,</span>
<span>                     legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>                     legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>                     plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span>,hjust <span class="op">=</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>                     plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">" "</span>, title <span class="op">=</span> <span class="st">" "</span>,</span>
<span>                           x <span class="op">=</span> <span class="st">" "</span>, y <span class="op">=</span> <span class="st">" "</span><span class="op">)</span></span></code></pre></div>
<p>We can visualise the clustering results</p>
<p><strong>Figure 4b</strong></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#pdf("DenMap.pdf", width =9, height=9)</span></span>
<span><span class="va">coord_outer</span></span>
<span><span class="co">#dev.off()</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tissue-layering">Tissue Layering<a class="anchor" aria-label="anchor" href="#tissue-layering"></a>
</h2>
<p>Vesalius provides a way to layer a territory and investigate gene
expression difference between layers. In the manuscript, we isolated the
Corpus Callosum and applied morphological operators to fill in the holes
and gaps. Then, we layered this isolated territory and after extracting
layer specific genes, we found the Kif5a and Stmn4 genes that were
highly expressed in the inner layers of the Corpus Callosum.</p>
<p>This sections produces:</p>
<ul>
<li><strong>Figure 4d</strong></li>
<li>DEGs are provided in the supplementary material</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># First step is to dilate the territory to fill in gaps and consider</span></span>
<span><span class="co"># neighbouring territories</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu">layerTerritory.edge</span><span class="op">(</span><span class="va">imageBrain</span>,<span class="fl">7</span>,morphologyFactor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">35</span>,<span class="fl">80</span><span class="op">)</span>,layerDepth <span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Now we can find layer specific gene expresison</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">totalLayerssc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">sc</span><span class="op">$</span><span class="va">layer</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Layeredsc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">totalLayerssc</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">idx</span>,<span class="va">layers</span>,<span class="va">ter</span>,<span class="va">counts</span><span class="op">)</span><span class="op">{</span></span>
<span>                    <span class="va">query</span> <span class="op">&lt;-</span> <span class="va">layers</span><span class="op">[</span><span class="op">!</span><span class="va">layers</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">idx</span><span class="op">]</span></span>
<span>                    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">compareLayers</span><span class="op">(</span><span class="va">ter</span>,<span class="va">counts</span>,<span class="va">idx</span>,<span class="va">query</span>,logFC <span class="op">=</span><span class="fl">0.25</span><span class="op">)</span></span>
<span>                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">==</span><span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>                    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="op">}</span>,<span class="va">totalLayerssc</span>,<span class="va">sc</span>,<span class="va">brainNorm</span><span class="op">)</span></span>
<span><span class="va">Layeredsc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>,<span class="va">Layeredsc</span><span class="op">)</span></span>
<span><span class="va">Layeredsc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Layeredsc</span> ,<span class="va">logFC</span> <span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Plotting Figure 4d</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"Kif5a.pdf"</span>,width<span class="op">=</span><span class="fl">9</span>,height<span class="op">=</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">scPlot</span> <span class="op">&lt;-</span> <span class="fu">viewLayerExpression</span><span class="op">(</span><span class="va">sc</span>,<span class="va">brainNorm</span>,genes <span class="op">=</span> <span class="st">"Kif5a"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="st">"cm"</span><span class="op">)</span>,</span>
<span>                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">25</span><span class="op">)</span>,</span>
<span>                legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>                legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span><span class="st">"Kif5a"</span><span class="op">)</span></span>
<span><span class="va">scPlot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="st">"Stmn4.pdf"</span>,width<span class="op">=</span><span class="fl">9</span>,height<span class="op">=</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">scPlot</span> <span class="op">&lt;-</span> <span class="fu">viewLayerExpression</span><span class="op">(</span><span class="va">sc</span>,<span class="va">brainNorm</span>,genes <span class="op">=</span> <span class="st">"Stmn4"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="st">"cm"</span><span class="op">)</span>,</span>
<span>                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">25</span><span class="op">)</span>,</span>
<span>                legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>                legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span><span class="st">"Stmn4"</span><span class="op">)</span></span>
<span><span class="va">scPlot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="umap-vs-pca">UMAP vs PCA<a class="anchor" aria-label="anchor" href="#umap-vs-pca"></a>
</h2>
<p>In the section, we aim to demonstrate the differences between using
UMAP or PCA embeddings in your color images.</p>
<p>The main aspect to consider is how much data is being included in the
image. UMAP projections can contain an arbitrary number of PCs and in
turn this means that more <em>information</em> can be included into the
final images. While this does sound like a good thing, it also means
that more subtle patterns might be merged together in color space.</p>
<p>PCA slices - on the other hand - can only show 3 PCs at a time to
create RGB images. Obviously, in this case there is less
<em>information</em> included in the final image. However, this
generates images that emphasise different part of the ST assay. We can
use these different slices and images to explores different sections of
the ST assay and focus our attention on different territories.</p>
<p>This section produces:</p>
<ul>
<li><strong>Figure S2</strong></li>
</ul>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Using slide-seq data sets</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="va">slideTag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Puck_200115_08"</span>,<span class="st">"Puck_190926_03"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slideBeads</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08_bead_locations.csv"</span>,</span>
<span>               <span class="st">"~/group/slide_seqV2/Puck_190926_03_bead_locations.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slideCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08.digital_expression.txt.gz"</span>,</span>
<span>                 <span class="st">"~/group/slide_seqV2/Puck_190926_03.digital_expression.txt.gz"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># Next we can set a few parameters for the pre-processing</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co">## number of variable features</span></span>
<span><span class="va">nfeatures</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span></span>
<span><span class="co">## Output directory</span></span>
<span><span class="va">IP</span> <span class="op">&lt;-</span> <span class="st">"~/group/slide_seqV2/IP/"</span></span>
<span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span><span class="co"># We will convert to UMAP and PCA Images</span></span>
<span><span class="co">#------------------------------------------------------------------------------#</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">slideTag</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># storing plots for output</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Loading coordinates</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">bead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ReadSlideSeq.html" class="external-link">ReadSlideSeq</a></span><span class="op">(</span><span class="va">slideBeads</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Unconventional loading - however required as some data sets</span></span>
<span>  <span class="co"># Fail to load  - This ensures all data sets can be loaded</span></span>
<span>  <span class="co"># Count matrix</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">slideCounts</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, header <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">count</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="va">count</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Creating seurat spatial object</span></span>
<span>  <span class="co"># NOTE this code is taken from the Seurat source code as it does not seem that</span></span>
<span>  <span class="co"># Slide seq loading function are all exported</span></span>
<span>  <span class="co"># If this has been updated - this section can be changed accordingly</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span><span class="va">count</span>, assay <span class="op">=</span><span class="st">"Spatial"</span><span class="op">)</span></span>
<span>  <span class="va">bead</span> <span class="op">&lt;-</span> <span class="va">bead</span><span class="op">[</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/Cells.html" class="external-link">Cells</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">count</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">bead</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span></span>
<span>  <span class="va">count</span><span class="op">[[</span><span class="st">"slice1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bead</span></span>
<span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Seuart pre-processing steps</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">count</span>, nfeatures <span class="op">=</span> <span class="va">nfeatures</span><span class="op">)</span></span>
<span>  <span class="va">count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Embed UMAP projections into the RGB colour space and building image</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">umaps</span> <span class="op">&lt;-</span> <span class="fu">rgbUMAP</span><span class="op">(</span><span class="va">count</span>, pcs <span class="op">=</span><span class="fl">30</span>, conserveSparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">umaps</span> <span class="op">&lt;-</span> <span class="fu">buildImageArray</span><span class="op">(</span><span class="va">umaps</span>,</span>
<span>                          filterThreshold <span class="op">=</span> <span class="fl">0.995</span>,</span>
<span>                          resolution <span class="op">=</span> <span class="fl">40</span>,</span>
<span>                          cores<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="va">plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">imagePlot</span><span class="op">(</span><span class="va">umaps</span>, as.cimg <span class="op">=</span><span class="cn">F</span>, cex <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Embed PCA loadings into the RGB colour space and building image</span></span>
<span>  <span class="co"># Here we are going through multiple slices as only 3 pcs are represented</span></span>
<span>  <span class="co"># at a time. We will also increase contrast to help with visualisation</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">pcs</span> <span class="op">&lt;-</span> <span class="fu">rgbPCA</span><span class="op">(</span><span class="va">count</span>, slices <span class="op">=</span> <span class="fl">5</span> ,conserveSparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">counter</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">pcs</span><span class="op">$</span><span class="va">slice</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">buildImageArray</span><span class="op">(</span><span class="va">pcs</span>,</span>
<span>                           sliceID <span class="op">=</span> <span class="va">j</span>,</span>
<span>                           resolution<span class="op">=</span><span class="fl">40</span>,</span>
<span>                           filterThreshold<span class="op">=</span><span class="fl">0.995</span>,</span>
<span>                           cores<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">equalizeHistogram</span><span class="op">(</span><span class="va">tmp</span>,sleft<span class="op">=</span><span class="fl">3</span>, sright<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="va">counter</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">imagePlot</span><span class="op">(</span><span class="va">tmp</span>,as.cimg <span class="op">=</span><span class="cn">F</span>, cex<span class="op">=</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">counter</span> <span class="op">&lt;-</span> <span class="va">counter</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="co"># Plot the outputs</span></span>
<span>  <span class="co">#----------------------------------------------------------------------------#</span></span>
<span>  <span class="va">fileOut</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">slideTag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_UMAP_vs_PCA_Vesalius.pdf"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="va">fileOut</span>, width <span class="op">=</span> <span class="fl">15</span>, height <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html" class="external-link">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/viewports.html" class="external-link">pushViewport</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span>layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/grid.layout.html" class="external-link">grid.layout</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">vplayout</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span>layout.pos.row <span class="op">=</span> <span class="va">x</span>, layout.pos.col <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">plots</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">curRow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">j</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span></span>
<span>      <span class="va">curCol</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">j</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">3</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">plots</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>, vp <span class="op">=</span> <span class="fu">vplayout</span><span class="op">(</span><span class="va">curRow</span>, <span class="va">curCol</span> <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>As seen in these figures, images generated in the embryo show a
extremely diverse set of territories between PC slices compared to the
brain. The approach provided by Vesalius enables a different way of
gaining insight into ST assays. The use of PCA instead of UMAP
projections decomposes the variance contained in the ST assay into
smaller sections that can easily be visualised. We hope that this
approach can contribute to capitalising on the information contained in
high resolution ST data sets.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>We hope that this has given you insights into how Vesalius works and
what you can do with this tool. All figures produced here are the ones
used in the manuscript. All ISH images are taken from the Allen Brain
Atlas.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Patrick C.N. Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
